<div id="media-photos" class="">
  <system-spirit animations="zoom" zoom="album">
    <system-ui-view module="content-management/media" name="albums-list" class="block-row">  
      <div tabindex="1" v-for="album in albums" track-by="id" class="content-item album" 
           v-if="albumId === 0"
           v-on:focus="selectItem(album.id)" 
           v-on:dblclick="openAlbum(album.id)">
        <span></span>
        <p>{{ album.title }}</p>
      </div>      
    </system-ui-view>
  </system-spirit>

  <system-ui-view module="content-management/media" name="album-card" class="grid">
    <div class="grid-header">
      <div class="card-title-action"></div>
      <div class="card-title-action-right"></div>
      <h1>
        tr{Media}
      </h1>
    </div>
    <system-spirit animations="zoom" zoom="grid-cell">
      <div class="album-images-list grid-content block-row">
        <div tabindex="1" class="grid-cell image"
             v-for="image in images" 
             v-on:focus="selectItem(image.id)" >
          <img alt="{{image.title}}" v-bind:src="image.thumbURL" />
          <div class="grid-cell-caption">
            <p class="title date">{{ image.size }} KB</p>
            <button class='pull-right btn-text btn-circle btn-danger icon-delete' v-on:click="deleteImage(image.id)"></button>
          </div>
        </div>
      </div>
    </system-spirit>
  </system-ui-view>
</div> 

<script>
  /* global System */

  function MediaPhotos(scope, state) {
    var component = this;
    component.scope = scope;
    component.state = state;
    component.data = {};

    component.state.onInit = function () {
      component.init();
    };

    component.state.onStart = function () {
      component.start();
    };
  }

  MediaPhotos.prototype.init = function () {
    var component = this;
    this.albumId = null;
    this.albumCard = $(component.scope.uiViews.album_card).hide();
    this.albumCardTitleAction = this.albumCard.find(".card-title-action");
    this.albumCardTitleActionRight = this.albumCard.find(".card-title-action-right");
    this.albumsList = $(component.scope.uiViews.albums_list);
    this.audiosList = $(component.scope.uiViews.audios_list);
    this.currentItem = null;
    
    component.state.on('album', function (e, id, images) {
      if (id > 0) {
        component.data.uploadImage = false;
      } else {
        component.data.uploadImage = true;
      }

      if (!id) {
        id = 0;
      }

    if (images) {
        if (id !== null && component.albumId !== id) {
          component.albumId = parseInt(id);
          if (component.listInited) {
            component.state.setParam("select", null, true);
          }

          component.listMedia();
        }
      }
    });

//    component.state.on('select', component.states.select);

    this.albumPropertiesBtn = EW.addActionButton({
      text: '', handler: function () {
        handler.seeAlbumActivity({albumId: System.getHashNav("album")[0]
        });
      },
      class: "btn btn-text btn-default btn-circle icon-edit",
      parent: this.albumCardTitleActionRight
    });
    this.deleteAlbumActivity = EW.addActivity({
      activity: "admin/api/content-management/delete-album",
      text: "tr{}",
      class: "btn btn-text btn-circle btn-danger icon-delete",
      parent: this.albumCardTitleActionRight,
      parameters: function () {
        if (!confirm("tr{Are you sure of deleting this album?}")) {
          return false;
        }
        return {
          id: component.albumId
        };
      },
      onDone: function (response) {
        $("body").EW().notify(response).show();
        System.setHashParameters({
          album: "0/images"
        });
      }
    });

    this.deleteImageActivity = EW.getActivity({
      activity: "admin/api/content-management/delete-image",
      parameters: function () {
        if (!confirm("tr{Are you sure of deleting this image?} ")) {
          return false;
        }
        return {
          'id': component.selectedItemId
        };
      },
      onDone: function (response) {
        $("body").EW().notify(response).show();
        component.listMedia();
      }
    });

    this.bBack = EW.addActionButton({
      text: "", class: "btn-text btn-default btn-circle icon-back",
      handler: function () {
        System.setHashParameters({
          album: "0/images"
        });
      },
      parent: this.albumCardTitleAction
    });

    this.seeAlbumActivity = EW.getActivity({
      activity: "admin/html/content-management/media/album-form.php",
      parent: "action-bar-items",
      modal: {
        class: "center properties"
      }
    });
console.log(component.scope)
    component.media_photos_vue = new Vue({
      el: component.scope.ui.filter('#media-photos')[0],
      data: {
        albumId: 0,
        albums: [],
        images: []
      },
      methods: {
        openAlbum: function (albumId) {
          component.state.setParam('album', albumId + '/images');
        },
        selectItem: function (id) {
          component.selectedItemId = id;
          component.state.setParam("select", id);
        },
        deleteImage: function (id) {
          component.selectedItemId = id;
          component.deleteImageActivity();
        }
      }
    });

    $(document).off("media-list.refresh").on("media-list.refresh", function () {
      component.listMedia();
    });

    $(document).off('media.audios.list.refresh').on('media.audios.list.refresh', function (e, eventData) {
      component.audiosListTable.refresh();
    });
  };

  MediaPhotos.prototype.start = function () {
    var component = this;
    this.itemsList = $();
    this.bDel = $();
    this.listInited = false;

    System.entity('ui/primary-actions').actions = [
      {
        title: "tr{New Album}",
        activity: "admin/html/content-management/media/album-form.php",
        //parent: System.UI.components.mainFloatMenu,
        parameters: function (params) {
          params.albumId = null;
          return params;
        }
      }

    ];

//      this.newAlbumActivity = EW.addActivity();

    this.uploadImageActivity = {
      title: "tr{Upload Photo}",
      activity: "admin/html/content-management/media/upload-form.php",
      hide: true,
      //parent: System.UI.components.mainFloatMenu,
      parameters: function () {
        return {
          parentId: System.getHashNav("album")[0]
        };
      },
      onDone: function () {
        EW.setHashParameter("parentId", null);
      }
    };

    System.entity('ui/primary-actions').actions = [
      {
        title: "tr{New Album}",
        activity: "admin/html/content-management/media/album-form.php",
        //parent: System.UI.components.mainFloatMenu,
        parameters: function (params) {
          params.albumId = null;
          return params;
        }
      },
      this.uploadImageActivity
    ];

//      this.uploadAudioActivity = EW.addActivity({
//        title: "tr{Upload Audio}",
//        activity: "admin/html/content-management/media/upload-audio-form.php",
//        parent: System.UI.components.mainFloatMenu,
//        parameters: function () {
//          return {
//            parentId: System.getHashNav("album")[0]
//          };
//        },
//        onDone: function () {
//          System.setHashParameters({
//            parentId: null
//          });
//        }
//      });

    this.albumCard[0].show();
    this.albumsList[0].show();
//    this.audiosList[0].show();
//    this.ui.components.tabs_pills = $('#content-media-tabs');

    // Select photos tab if no tab is selected
//      component.module.data.tab = component.module.data.tab || component.module.getNav('app')[2];
//      if (!component.module.data.tab) {
//        component.module.setParam('app', 'content-management/media/photos');
//      }


  };

  MediaPhotos.prototype.seeItemDetails = function () {
    var albumId = this.selectedItemId;
    EW.activeElement = this.currentItem;
    if (albumId) {
      this.albumId = albumId;
      this.seeAlbumActivity({albumId: albumId
      });
    }
  };

  MediaPhotos.prototype.seeImageActivity = function (id) {

  };

  MediaPhotos.prototype.listMedia = function () {
    var stateHandler = this;
    //var albums = $("<div class='row box-content'></div>");
    //this.itemsList = $("<div class='box-content anim-fade-in'></div>");
    var elementsList = $("#files-list");
    elementsList.html("<h2>Loading...</h2><div class='loader center'></div>");
    this.listInited = false;
    //var listContainer = component.albumCard.find(".card-content");
    //component.itemsList = component.albumCard.find(".album-images-list").empty();
    var albumsList = this.albumsList.children().eq(0);
    if (stateHandler.albumId === 0) {
      //this.albumPropertiesBtn.comeOut();
      //this.deleteAlbumBtn.comeOut();
    } else {
      //this.albumPropertiesBtn.comeIn();
      //this.deleteAlbumBtn.comeIn();
    }

    $.get('api/admin/content-management/get-media-list/', {
      parent_id: stateHandler.albumId
    }, done);

    function done(response) {
      if (stateHandler.albumId === 0) {
        stateHandler.albumCard.hide();
        albumsList.show();
        stateHandler.itemsList = albumsList;
        albumsList.empty();
      } else {
        stateHandler.albumCard.show();
        albumsList.hide();
        stateHandler.albumCard.find("h1").text(response.included.album.title);
      }

      stateHandler.media_photos_vue.albumId = stateHandler.albumId;

      if (stateHandler.albumId === 0) {
        stateHandler.media_photos_vue.albums = response.data;
      } else {
        stateHandler.media_photos_vue.images = response.data;
      }

      stateHandler.listInited = true;
      stateHandler.media_photos_vue.$nextTick(function () {
        if (stateHandler.selectedItemId) {
          $("div[data-item-id='" + stateHandler.selectedItemId + "']").focus();
        }
      });
    }
  };

  Scope.export = MediaPhotos;

  System.state('content-management/media/photos', function (state) {
    new MediaPhotos(Scope, state);
  });

</script>