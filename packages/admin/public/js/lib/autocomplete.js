/**
 * Copyright Yehuda Katz
 * with assistance by Jay Freeman
 * 
 * You may distribute this code under the same license as jQuery (BSD or GPL
 **/
!function(a){a.makeTemplate=function(a,b,c){var d=b.replace(/([\]{}[\\])/g,"\\$1"),e=c.replace(/([\]{}[\\])/g,"\\$1"),f="try { with (_context) {var _result = '';"+a.replace(/[\t\r\n]/g," ").replace(/^(.*)$/,c+"$1"+b).replace(new RegExp(e+"(.*?)"+d,"g"),function(a){return a.replace(new RegExp("^"+e+"(.*)"+d+"$"),"$1").replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/^(.*)$/,c+"_result += '$1';"+b)}).replace(new RegExp(d+"=(.*?)"+e,"g"),"_result += ($1);").replace(new RegExp(d+"(.*?)"+e,"g")," $1 ").replace(new RegExp("^"+e+"(.*)"+d+"$"),"$1")+"return _result;} } catch(e) { return '' } ";return new Function("_context",f)}}(jQuery),function(a){a.ui=a.ui||{},a.ui.autocomplete=a.ui.autocomplete||{},a.ui.autocomplete.ext=a.ui.autocomplete.ext||{};var b={},c={ESC:27,RETURN:13,TAB:9,BS:8,DEL:46,UP:38,DOWN:40};a.fn.autocomplete=function(b){function d(){var c=b.templateBegin||"<%",d=b.templateEnd||"%>",e=a.makeTemplate(b.templateText,c,d);b.template=function(a){return e(a)}}function e(b){var d=b.which||b.keycode;a.data(document.body,"autocompleteMode")&&d==c.TAB&&b.preventDefault()}function f(c,d){a.data(d,"typingTimeout")||(a.data(d,"typingTimeout",!0),window.setTimeout(function(){a.data(d,"typingTimeout")&&(a.data(d,"typingTimeout",!1),a(c.target||c.srcElement).triggerHandler("autocomplete"))},b.timeout))}return b=a.extend({},{container:null,timeout:300,threshold:100,adjustWidth:!0,maxResults:void 0,minCharacters:0,getList:function(a){a.triggerHandler("updateList",[b.list])},match:function(a,b){return void 0!=a.match(b)},matcher:function(a){return new RegExp(a)},filterList:function(c,d){var e=b.matcher(d),f=function(a,c){return b.match(a,e)},g=0;return this.maxResults&&(f=function(a,c){return!(g>this.maxResults)&&(g++,b.match(a,e))}),a.grep(c,f)},updateList:function(a,c){return!(!a||0==a.length)&&(!(b.minCharacters&&c.length<=b.minCharacters)&&b.buildList(a))},buildList:function(c){for(var d=a(c).map(function(){var c=a(b.template(this))[0];return a.data(c,"originalObject",this),c}),e=a(b.wrapper).append(d),f=a(b.wrapper)[0].tagName;e[0].tagName!==f;)e=e.children(":first");return e},wrapper:"<ul class='autocomplete dropdown-menu'></ul>",displayList:function(c,d){var e=c.offset(),f=a(document).height()-(e.top+c.outerHeight());return d.css({top:e.top+c.outerHeight(),left:e.left,width:this.adjustWidth?c.outerWidth():void 0}).appendTo("body").show(),e.top+c.outerHeight()+d.outerHeight()>a(document).height()?d.css({height:f+"px"}):d.css({height:""}),b.input=c,b.container=d,d},dismissList:function(a){a.remove()},template:function(a){return"<li>"+b.insertText(a)+"</li>"},insertText:function(a){return a},source:function(c){var d=b.source;if(c.val().match(/^\s*$/))return!1;var e={filter:c.val()};console.log(e),a.getJSON(d,e,function(a){c.trigger("updateList",[a])})},templateText:null},b),b.source&&("string"==typeof b.source?b.getList=b.source():"function"==typeof b.source&&(b.getList=b.source)),b.templateText&&d(b),this.each(function(){var d=a(this);b.input=d;var g=b.input.offset();setInterval(function(){var a=b.input.offset().top;a!==g&&b.container&&b.input&&(g=a,b.container.css({top:a.top+b.input.outerHeight()}))},100),d.attr("autocomplete","off").keydown(function(b){var d=a.data(this,"typingTimeout"),g=b.keyCode||b.which;(g!=c.UP&&g!=c.DOWN||a.data(this,"typingTimeout"))&&(g==c.BS||g==c.DEL||g!=c.RETURN?(d&&a.data(this,"typingTimeout",!1),f(b,this)):e(b),a.data(document.body,"suppressKey")&&a.data(document.body,"suppressKey",!1))}).bind("autocomplete",function(){d.one("updateList",function(c,e,f){var g=b.updateList(e,f||d.val());return a("body").triggerHandler("off.autocomplete"),g!==!1&&(b.container=b.displayList(d,g),void a("body").autocompleteMode(b.container,d,g.find("li").length,b))}),b.getList(d)}),"function"==typeof b.init&&b.init(d)})},a.fn.autocompleteMode=function(d,e,f,g){var h=e.val(),i=-1,j=!1;a.data(document.body,"autocompleteMode",!0),a("body").one("cancel.autocomplete",function(){e.triggerHandler("cancelled.autocomplete"),a("body").triggerHandler("off.autocomplete"),e.val(h)}),a("body").bind("activate.autocomplete",function(c){if(b.length)e.triggerHandler("activated.autocomplete",[a.data(b[0],"originalObject"),b]);else if(j)return j=!1,document.activeElement&&document.activeElement!=e&&e.trigger("focus"),!1;a("body").triggerHandler("off.autocomplete")}),a("body").one("off.autocomplete",function(b,c){a.data(e,"typingTimeout",!1),g.dismissList(d),a.data(document.body,"autocompleteMode",!1),e.unbind("keydown.autocomplete"),a("body").add(window).unbind("click.autocomplete").unbind("cancel.autocomplete").unbind("activate.autocomplete")}),a(window).bind("click.autocomplete",function(){a("body").triggerHandler("cancel.autocomplete")});var k=function(){if(b=d.find("li").removeClass("active").filter(":visible").slice(i,i+1).addClass("active"),b.length){var c=d.outerHeight(),f=b.position().top,j=f+b.outerHeight();j>c?d.stop().animate({scrollTop:"+="+(j-c)},120):f<0&&d.stop().animate({scrollTop:"-="+Math.abs(f)},120),e.triggerHandler("itemSelected.autocomplete",[a.data(b[0],"originalObject"),b]),e.val(g.insertText(a.data(b[0],"originalObject"))).change()}else e.triggerHandler("noneSelected.autocomplete"),e.val(h)};d.mouseover(function(a){}).mouseout(function(a){}).mousedown(function(){j=!0}).bind("click.autocomplete",function(b){if(b.preventDefault(),b.target!=d[0]){var c=a(b.target).is("li")?a(b.target)[0]:a(b.target).parents("li")[0];i=d.find("li").index(c),k(),a("body").triggerHandler("activate.autocomplete"),a.data(document.body,"suppressKey",!1)}}),e.bind("keydown.autocomplete",function(b){var d=b.which||b.keyCode;switch(d){case c.ESC:a("body").triggerHandler("cancel.autocomplete");break;case c.TAB:case c.RETURN:i==-1&&(i=i>=f-1?0:i+1,k()),a("body").triggerHandler("activate.autocomplete");break;case c.DOWN:i=i>=f-1?0:i+1,k();break;case c.UP:i=i<=0?f-1:i-1,k();break;default:return!0}a.data(document.body,"suppressKey",!0)})}}(jQuery);